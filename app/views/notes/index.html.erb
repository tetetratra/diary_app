<div class="header">
  <h1 class="title"><%= link_to("#{@current_user.name}の日記", notes_path)%></h1>
</div>

<div class="note">
  <% note = @note; date = @note.date %>
  <% wd = %w[日 月 火 水 木 金 土][note.date.wday] %>
  <% wd_class = %w[sun mon tue wed thu fri sat][date.wday] %>
  <h2>
    <%= "#{date.month}/#{date.day}" %>
    <span class='<%= wd_class %>'>(<%= wd %>)</span>
  </h2>
  <textarea class="md-editor"></textarea>
  <p class='last-modified'>-</p>
</div>

<div class='menu'>
  <ul class='day_menu'>
    <%
      dates = case @date.beginning_of_month.wday
              when 0 then [nil] * 6
              else [nil] * (@date.beginning_of_month.wday - 1)
              end
      dates += [*@date.beginning_of_month..@date.end_of_month]
      dates += [nil] * (7 - dates.size % 7)
    %>
    <% dates.each_with_index do |date, index| %>
      <% if index % 7 == 0 %>
        <br>
      <% end %>
      <% if date %>
        <% d = date.day %>
        <% wd_class = %w[sun mon tue wed thu fri sat][date.wday] %>
        <li class="<%= d == @date.day ? 'current_day' : '' %>">
          <%= link_to("#{d}日", notes_path(date: Date.new(@date.year, @date.month, d)), { class: wd_class }) %>
        </li>
      <% else %>
        <li>-</li>
      <% end %>
    <% end %>
  </ul>

  <ul class='month_menu'>
    <% if @date.year - 1 >= Date.today.year - 1 %>
      <li><%= link_to("#{@date.year - 1}年", notes_path(date: Date.new(@date.year - 1, 12, 31))) %></li>
    <% end %>
    <% (1..12).each do |m|%>
      <li class="<%= m == @date.month ? 'current_month' : '' %>"><%= link_to("#{m == @date.month ? "#{@date.year}年" : '' }#{m}月", notes_path(date: Date.new(@date.year, m, 1))) %></li>
    <% end %>
    <% if @date.year + 1 <= Date.today.year + 1 %>
      <li><%= link_to("#{@date.year + 1}年", notes_path(date: Date.new(@date.year + 1, 1, 1))) %></li>
    <% end %>
  </ul>
</div>

<div class="footer">
  <hr>
  <div class='logout'><%= link_to('ログアウト', logout_path)%></div>
  <div class='csvdl'><%= link_to('CSVをDL', csv_download_path(format: 'csv', year: @date.year)) %></div>
</div>

<script>
  window.addEventListener('load', e => {
    const mdEditor = new SimpleMDE({
      element: document.querySelector('textarea.md-editor'),
      spellChecker: false,
      status: [],
      renderingConfig: {
        codeSyntaxHighlighting: true
      }
    })
    mdEditor.value((new DOMParser().parseFromString("<%= escape_javascript @note.text %>", 'text/html')).documentElement.textContent)

    let noteTextPrev = mdEditor.value()
    let noteTextLastSaved = mdEditor.value()
    const CsrfToken = document.querySelector("meta[name=csrf-token]").content
    const noteId = '<%= @note.id %>'
    const saveNofity = document.querySelector('p.last-modified')

    function save(){
      const noteText = mdEditor.value()
      if(noteText !== noteTextPrev) {  // 入力中だと思われるのでセーブはまだしない
        noteTextPrev = noteText
        return
      }
      if(noteText === noteTextLastSaved) { // 変化無しならセーブしない
        return
      }

      fetch('/notes/' + noteId, {
        method: 'PATCH',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': CsrfToken
        },
        body: JSON.stringify({
          note: { text: noteText }
        })
      }).then(res => {
        saveNofity.textContent = 'saved'
        setTimeout(() => saveNofity.textContent = '-', 1000)
        noteTextLastSaved= noteText
      }).catch(err => {
        saveNofity.textContent = 'error!'
        setTimeout(() => saveNofity.textContent = '-', 1000)
      })
    }
    setInterval(() => save(), 2000)
  })
</script>

